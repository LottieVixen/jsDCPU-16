<!DOCTYPE html>
<html>
<meta charset="utf-8"/>
<title>JS DCPU-16</title>
<link rel="stylesheet" type="text/css" href="index.css"/>
<body>
<div id="debug"></div>
<script>
//define debug
const divDebug = document.querySelector('#debug'),
    debug = (text) => {
        divDebug.innerHTML += text+'<br/>';
    };

//define cpu class
class cpu {
	runProgram(program) {
        let dvInstruction = new DataView(program),
            instruction;

        for (let i = 0; i <= 256; i+= Uint32Array.BYTES_PER_ELEMENT) {
            instruction = dvInstruction.getUint32(i * Uint32Array.BYTES_PER_ELEMENT, true);

            debug(instruction.toString(2));

            let type = 'invalid';

            for (let ins in INSTRUCTIONS) {
                //debug('checking for '+ins)
                let bm0 = INSTRUCTIONS[ins][0],
                    bm1 = INSTRUCTIONS[ins][1],
                    onesmatch = bm1 == (instruction & bm1),
                    zeroesmatch = bm0 == (~instruction & bm0);
                //debug('Ones match: '+bm1.toString(2)+' == ' + instruction.toString(2) + ' & ' + bm1.toString(2) + ' : ' + onesmatch.toString());
                //debug('zeroes match: '+(bm0>>>0).toString(2)+' == ' + (~instruction>>>0).toString(2) + ' & ' + (bm0>>>0).toString(2) + ' : ' + zeroesmatch.toString());

                if (onesmatch && zeroesmatch) {
                    type = ins;
                    break;
                }
            }

            let cond = COND[instruction >> 28];

            if ('undefined' == typeof this[cond])
                throw new Error(cond + ' is an unimplemented condition');

            if ('undefined' == typeof this[type])
                throw new Error(type + ' is an unimplemented instruction type');

            //if (this[cond]())
                this[type](instruction);

            debug(type + ' ' + cond);
        }
    }
};

var ab2str = (buf) => {
  return String.fromCharCode.apply(null, new Uint8Array(buf));
}

//fetch init-memory
fetch('mem-binary')
    .then((response) => response.arrayBuffer())
    .then((arrayBuffer) => {
        console.log(ab2str(arrayBuffer));

    }).catch((err) => console.log(err));
</script>
</body>
</html>